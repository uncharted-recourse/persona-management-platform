const Kafka = require('kafka-node');
const Uuid = require('uuid/v4');

const createTopicIfNotExist = require('./create-topic-if-not-exist');
const createClient = require('./create-client');

function createConsumer(topics, groupId = Uuid(), optionsOverride = {}) {
  const client = createClient();
  return new Promise((resolve, reject) => {
    client.on('ready', () => {
      const consumerOptions = Object.assign({}, {
        groupId,
        autoCommit: true,
        fromOffset: false,
        encoding: 'utf8'
      }, optionsOverride);
      Promise.all(topics.map(topic => createTopicIfNotExist(client, topic.topic)))
        .then(() => {
          const newConsumer = new Kafka.Consumer(
            client,
            topics,
            consumerOptions
          );
          resolve(newConsumer);
        })
        .catch(err => reject(err));
    });
  });
}

module.exports = createConsumer;
